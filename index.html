<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora con Tabla</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container-fluid h-100 d-flex flex-column">
        <!-- Tabla de resultados -->
        <div class="table-responsive" style="height: 50%; overflow-y: auto;">
            <table class="table table-bordered table-striped text-center" id="resultTable">
                <thead>
                    <tr>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Total Producto</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button class="btn btn-primary" id="exportCsv">Exportar a CSV</button>
        </div>

        <!-- Calculadora -->
        <div class="mt-auto" style="height: 50%;">
            <div class="input-group mb-3">
                <textarea id="calculatorInput" class="form-control" rows="6" placeholder="Ingrese la ecuación..."></textarea>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            let dataJson = []; // Aquí almacenamos el JSON

            // Función para analizar la expresión y eliminar *1
            function parseEquation(equation) {
                const lines = equation.split('+'); // Dividir la expresión por el símbolo +
                const parsedLines = [];

                lines.forEach(line => {
                    const parts = line.split('*'); // Dividir por el símbolo *
                    if (parts.length === 2) {
                        const precioUnitario = parseFloat(parts[0].trim());
                        const cantidad = parseFloat(parts[1].trim());
                        parsedLines.push({
                            precioUnitario: precioUnitario,
                            cantidad: cantidad,
                            totalProducto: precioUnitario * cantidad
                        });
                    } else if (parts.length === 1) {
                        const precioUnitario = parseFloat(parts[0].trim());
                        parsedLines.push({
                            precioUnitario: precioUnitario,
                            cantidad: 1,
                            totalProducto: precioUnitario
                        });
                    }
                });

                return parsedLines;
            }

            // Función para generar la ecuación sin *1
            function generateEquation() {
                let equation = dataJson.map(item => {
                    // No mostrar *1 si la cantidad es 1
                    if (item.cantidad === 1) {
                        return `${item.precioUnitario}`;
                    } else {
                        return `${item.precioUnitario}*${item.cantidad}`;
                    }
                }).join('+');

                return equation;
            }

            function updateTable() {
                $('#resultTable tbody').empty(); // Limpiar la tabla

                dataJson.forEach(item => {
                    const row = $('<tr>')
                        .append(`<td contenteditable='true' class="editable">${item.precioUnitario}</td>`)
                        .append(`<td contenteditable='true' class="editable">${item.cantidad}</td>`)
                        .append(`<td>${item.totalProducto}</td>`);
                    $('#resultTable tbody').append(row);
                });

                // Actualizar la calculadora con la nueva ecuación
                $('#calculatorInput').val(generateEquation());
            }

            // Actualiza el JSON cuando se haga un cambio en la tabla
            $(document).on('blur', '.editable', function () {
                const rowIndex = $(this).closest('tr').index();
                const column = $(this).index();
                const newValue = parseFloat($(this).text());

                if (column === 0) {
                    // Precio Unitario
                    dataJson[rowIndex].precioUnitario = newValue;
                } else if (column === 1) {
                    // Cantidad
                    dataJson[rowIndex].cantidad = newValue;
                }

                // Actualizar el total producto
                dataJson[rowIndex].totalProducto = dataJson[rowIndex].precioUnitario * dataJson[rowIndex].cantidad;

                updateTable(); // Refrescar la tabla y calculadora
            });

            // Detectar cambios en el textarea de la calculadora
            $('#calculatorInput').on('input', function () {
                let equation = $(this).val();

                // Si el último carácter es un operador y no hay número después, agregar un valor predeterminado (0 o 1)
                if (equation.endsWith('+') || equation.endsWith('*')) {
                    if (equation.endsWith('*')) {
                        equation += '1'; // Agregar 1 después de *
                    } else {
                        equation += '0'; // Agregar 0 después de +
                    }
                    $(this).val(equation); // Actualizar el valor del textarea
                }

                if (!equation) return;

                try {
                    // Analizar la ecuación y actualizar el JSON
                    const parsedLines = parseEquation(equation);

                    // Actualizar el JSON con los nuevos cálculos
                    dataJson = parsedLines;
                    updateTable(); // Refrescar la tabla con los nuevos valores
                } catch (e) {
                    console.error('Error al procesar la ecuación:', e);
                }
            });

            // Detectar cambios al escribir un número después de un operador
            $('#calculatorInput').on('blur', function () {
                let equation = $(this).val();
                const lastChar = equation[equation.length - 1];

                // Si el último carácter es un operador y el siguiente es un número, quitar el valor predeterminado (0 o 1)
                if ((lastChar === '+' || lastChar === '*') && equation.length > 1) {
                    if (lastChar === '*') {
                        equation = equation.slice(0, -1) + '1'; // Reemplazar * con 1 si es por defecto
                    } else {
                        equation = equation.slice(0, -1) + '0'; // Reemplazar + con 0 si es por defecto
                    }
                    $(this).val(equation);
                }
            });

            // Exportar JSON a CSV
            $('#exportCsv').on('click', function () {
                let csv = 'Precio Unitario,Cantidad,Total Producto\n';
                dataJson.forEach(item => {
                    csv += `${item.precioUnitario},${item.cantidad},${item.totalProducto}\n`;
                });

                // Crear un enlace para descargar el archivo CSV
                const hiddenElement = document.createElement('a');
                hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                hiddenElement.target = '_blank';
                hiddenElement.download = 'data.csv';
                hiddenElement.click();
            });
        });
    </script>
</body>
</html>
